docker {
    name "$nexusHost:$nexusDockerRegistryPort/${jar.baseName}"
    dockerfile project.file("src/main/docker/Dockerfile")
    buildArgs(["JAR_FILE": "${jar.archiveName}"])
    files jar.archivePath, "src/main/docker/docker-entrypoint.sh"

    tasks.docker.dependsOn bootJar
    tasks.docker.shouldRunAfter test, itest
    assemble.dependsOn tasks.docker
}

// The docker plugin should be able to tag an image but fails to do so due to bug https://github.com/palantir/gradle-docker/issues/139
// This task is a workaround whereby we tag it ourselves
task dockerTag(dependsOn: tasks.docker) {
    tasks.docker.finalizedBy dockerTag

    doLast {
        exec {
            commandLine "docker", "tag", docker.name, docker.name + ":" + project.version
        }
    }
}
